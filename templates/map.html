{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
      type="text/css"
    />

    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css"
      type="text/css"
    />
      <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <title>Interactive Maps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    
    
    
    <div id="main" style="height: 91vh;">
      <div id="map" style="width: 100%; height: 100%; position: relative">
      </div>



    <script>
      const bounds = [
        [-75.323541,40.405131], // Southwest coordinates
        [-71.566392,41.411836] // Northeast coordinates
      ];
      mapboxgl.accessToken =
        "pk.eyJ1IjoiaGFtc2llIiwiYSI6ImNsODN4aWdmcjBhNHEzcGw4ZXYxMHcxaXkifQ.67o9saEURWg3rF02gZxGKg";
      const map = new mapboxgl.Map({
        container: "map", // container ID
        style: "mapbox://styles/mapbox/streets-v11?optimize=true", // style URL
        center: [-73.93, 40.73], // starting position [lng, lat]
        zoom: 11, // starting zoom
        maxBounds: bounds
      });

      const layerList = document.getElementById("menu");
      const inputs = layerList.getElementsByTagName("input");

      for (const input of inputs) {
        input.onclick = (layer) => {
          const layerId = layer.target.id;
          map.setStyle("mapbox://styles/mapbox/" + layerId);
        };
      }

      const nav = new mapboxgl.NavigationControl({
        visualizePitch: true,
      });
      map.addControl(nav, "bottom-right");

      map.on("style.load", () => {
        map.setFog({
          color: "rgb(186, 210, 235)", // Lower atmosphere
          "high-color": "rgb(36, 92, 223)", // Upper atmosphere
          "horizon-blend": 0.02, // Atmosphere thickness (default 0.2 at low zooms)
          "space-color": "rgb(11, 11, 25)", // Background color
          "star-intensity": 0.6, // Background star brightness (default 0.35 at low zoooms )
        });
      });

      var geocoder = new MapboxGeocoder({
        // Initialize the geocoder
        accessToken: mapboxgl.accessToken, // Set the access token
        mapboxgl: mapboxgl, // Set the mapbox-gl instance
        marker: false, // Do not use the default marker style
        {#placeholder: "Enter NYC Addresses ",#}
      });

      // Add the geocoder to the map
      map.addControl(geocoder);
      // After the map style has loaded on the page,
      // add a source layer and default styling for a single point

          var geolocate = new mapboxgl.GeolocateControl({
              positionOptions: {
                  {#enableHighAccuracy: true#}
              },
              // When active the map will receive updates to the device's location as it changes.
              trackUserLocation: true,
              // Draw an arrow next to the location dot to indicate which direction the device is heading.
              showUserHeading: true,
              showAccuracyCircle: false,
          })
      var user_location = null;
          function drawUserRadius(user_location) {
              let default_radius = 1;
              if(typeof map.getLayer('user-radius') === 'undefined') {
              let circle = turf.circle(user_location, default_radius, {units: 'miles'});
              map.addLayer({
                  "id": "user-radius",
                  "type": "fill",
                  "source": {
                      "type": "geojson",
                      "data": circle
                  },
                  "paint": {
                      "fill-color": "green",
                      "fill-opacity": 0.3
                  }
              });
          }
          }

      geolocate.on('geolocate', (e) => {
          user_location = turf.point([e.coords.longitude, e.coords.latitude]);
      });
          map.addControl(geolocate);
            var directions = new MapboxDirections({
                    accessToken: mapboxgl.accessToken,
                    interactive: false,
                });

    </script>

    
    <!-- TESTING HOW TO RETURN CLOSEST COORDINATE PAIR TO A GIVEN SET OF COORDINATES -->
    
    <!-- <script>
      
        HOW TO ITERATE THROUGH THE FARMERS MARKET DATABASE AND RETRIEVE LONG,LAT OF THE ENTRIES
        ___________________________________________________________________________
        {% for farmer_address in farmer_addresses %} 

        [{{ farmer_address.long }}, {{ farmer_address.lat }}];

        {% endfor %}
        _____________________________________________________________________________
               


        const haversine = ({longitude: lonA, latitude: latA}, {longitude: lonB, latitude: latB}) => {
        const {PI, sin, cos, atan2} = Math,
              r = PI/180,
              R = 6371,
              deltaLat = (latB - latA)*r,
              deltaLon = (lonB - lonA)*r,
              a = sin(deltaLat / 2)**2 + cos(cos(latB*r)*latA*r) * sin(deltaLon /2)**2,
              c = 2 * atan2(a**0.5, (1 - a)**0.5),
              d = R * c
        return d
      },
      

      arr = [{"latitude":55.85,"longitude":4.22},{"latitude":55.89,"longitude":4.16},{"latitude":55.88,"longitude":-4.24}],
      
      {closest} = arr.reduce((r,o) => {
        const distance = haversine(o, obj)
        distance < r.minDistance || !r.closest &&
        (r.closest = o, r.minDistance = distance)
        return r
      }, {closest: null, minDistance: null})
      
console.log(closest) -->

  </body>
</html>
