{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
      type="text/css"
    />

    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css"
      type="text/css"
    />
      <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <link rel="stylesheet" href="{% static 'css/mapPage.css' %}" />
    <title>Interactive Maps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <header>
      <h1>
        <a href="{% url 'home' %}" class="home">
          <div class="logo one">Ascent+</div>
          <div class="logo two">Interactive</div>
        </a>
      </h1>
      <div class="pages">
        <a href="{% url 'home' %}" class="page-link">Home</a>
        <a href="{% url 'map' %}" class="page-link">Map</a>
        <a href="{% url 'aboutme' %}" class="page-link">About</a>
      </div>
    </header>

    <div id="map" style="width: 100%; height: 70vh"></div>

    <div id="menu">
      <input
        id="streets-v11"
        type="radio"
        name="rtoggle"
        value="streets"
        checked="checked"
      />
      <!-- See a list of Mapbox-hosted public styles at -->
      <!-- https://docs.mapbox.com/api/maps/styles/#mapbox-styles -->
      <label for="streets-v11">streets</label>
      <input id="light-v10" type="radio" name="rtoggle" value="light" />
      <label for="light-v10">light</label>
      <input id="dark-v10" type="radio" name="rtoggle" value="dark" />
      <label for="dark-v10">dark</label>
      <input
        id="navigation-night-v1"
        type="radio"
        name="rtoggle"
        value="night"
      />
      <label for="navigation-night-v1">night</label>
      <input
        id="satellite-streets-v11"
        type="radio"
        name="rtoggle"
        value="satellite"
      />
      <label for="satellite-streets-v11">satellite</label>
    </div>
    <div class="radius-slider-container">
        Radius: <input type="range" min="1" max="10" value="10" id="radius-slider">
        <input id="radius-input" type="number" min="1" max="10" value="10">
    </div>
    
    <script>




        const RADIUS_LIMIT = 10;
        let radius_slider = document.getElementById('radius-slider');
        let radius_input = document.getElementById('radius-input');
        let first_change = true;

        radius_slider.addEventListener('change', (e) => {
           radius_input.value = e.target.value;
           if(user_location != null)
           {
               if(first_change)
                {
                    first_change = false;
                    drawUserRadius(user_location, parseFloat(e.target.value));
                }
               let circle = turf.circle(user_location, parseFloat(e.target.value), {units: 'miles'});
               map.getSource('user-radius').setData(circle);
           }
        });
        radius_input.addEventListener('change', (e) => {
            radius_slider.value = e.target.value;
            radius_input.value = e.target.value > RADIUS_LIMIT ? RADIUS_LIMIT : e.target.value;
            if(user_location != null)
            {
                if(first_change)
                {
                    first_change = false;
                    drawUserRadius(user_location, parseFloat(e.target.value));
                }
                let circle = turf.circle(user_location, parseFloat(e.target.value), {units: 'miles'});
                map.getSource('user-radius').setData(circle);
            }
        })
      // const bounds = [
      //   [-75.323541,40.405131], // Southwest coordinates
      //   [-71.566392,41.411836] // Northeast coordinates
      // ];

      const bounds = [
        [-75.323541,40.405131], // Southwest coordinates
        [-71.566392,41.411836] // Northeast coordinates
      ];

      mapboxgl.accessToken =
        "pk.eyJ1IjoiYXJpZWxiMSIsImEiOiJjbGIxbnFyNW4wNXVjM3dueW5lbGVoeDRnIn0.8_79cvoMd9lBAUQKUe27tA";
      const map = new mapboxgl.Map({
        container: "map", // container ID
        style: "mapbox://styles/mapbox/streets-v11?optimize=true", // style URL
        center: [-73.93, 40.73], // starting position [lng, lat]
        zoom: 13, // starting zoom
        zoom: 11, // starting zoom
        // maxBounds: bounds
      });
      
















    

      const layerList = document.getElementById("menu");
      const inputs = layerList.getElementsByTagName("input");

      for (const input of inputs) {
        input.onclick = (layer) => {
          const layerId = layer.target.id;
          map.setStyle("mapbox://styles/mapbox/" + layerId);
        };
      }

      const nav = new mapboxgl.NavigationControl({
        visualizePitch: true,
      });
      map.addControl(nav, "bottom-right");

      map.on("style.load", () => {
        map.setFog({
          color: "rgb(186, 210, 235)", // Lower atmosphere
          "high-color": "rgb(36, 92, 223)", // Upper atmosphere
          "horizon-blend": 0.02, // Atmosphere thickness (default 0.2 at low zooms)
          "space-color": "rgb(11, 11, 25)", // Background color
          "star-intensity": 0.6, // Background star brightness (default 0.35 at low zoooms )
        });
      });

      var geocoder = new MapboxGeocoder({
        // Initialize the geocoder
        accessToken: mapboxgl.accessToken, // Set the access token
        mapboxgl: mapboxgl, // Set the mapbox-gl instance
        marker: false, // Do not use the default marker style
        placeholder: " ",
      });

      // Add the geocoder to the map
      map.addControl(geocoder);
      // After the map style has loaded on the page,
      // add a source layer and default styling for a single point

          var geolocate = new mapboxgl.GeolocateControl({
              positionOptions: {
                  enableHighAccuracy: true
              },
              // When active the map will receive updates to the device's location as it changes.
              trackUserLocation: true,
              // Draw an arrow next to the location dot to indicate which direction the device is heading.
              showUserHeading: true,
              showAccuracyCircle: false,
          })
      var user_location = null;
          function drawUserRadius(user_location, radius) {
              if(typeof map.getLayer('user-radius') === 'undefined') {
              let circle = turf.circle(user_location, radius, {units: 'miles'});
              map.addLayer({
                  "id": "user-radius",
                  "type": "fill",
                  "source": {
                      "type": "geojson",
                      "data": circle
                  },
                  "paint": {
                      "fill-color": "green",
                      "fill-opacity": 0.3
                  }
              });
          }
          }
          
          
 
      geolocate.on('geolocate', (e) => {
          user_location = turf.point([e.coords.longitude, e.coords.latitude]);
          map.flyTo({
              center:[e.coords.longitude, e.coords.latitude],
              zoom: 11
          });
      });
          map.addControl(geolocate);

        var directions = new MapboxDirections({
                    accessToken: mapboxgl.accessToken,
                    interactive: false,
                });
    </script>
   
    <button id="button1" onclick="showmarker()">Grocery Stores</button>
    <button id="button2" onclick="showmarker2()">Farmers Markets</button>
    <button id="button3" onclick="showmarker3()">Fire Stations</button>
    <button id="button4" onclick="showmarker4()">Supermarkets</button>
    <button id="button5" onclick="showmarker5()">Supercenters</button>

    <div><button id="find_nearest_business_button" onclick="showdirections()">Find Nearest</button></div>
</script>
    <script>
      

               var marker1showing = false;
               var marker2showing = false;
               var marker3showing = false;
               var directionsshowing = false;
               var marker1s = [];
               var marker2s = [];
               var marker3s = [];
               function showmarker()
               {
                   if (typeof map.getSource('grocery-stores') === 'undefined') {
                       map.addSource('grocery-stores', {
                           type: 'vector',
                           url: 'mapbox://arielb1.38i7mvbz'
                       });
                       map.addLayer({
                           'id': 'grocery-stores',
                           'type': 'circle',
                           'source': 'grocery-stores',
                           'layout': {
                               'visibility': 'visible'
                           },
                           'paint': {
                               'circle-radius': 4,
                               'circle-color': 'rgba(0,0,255,1)',
                               'circle-stroke-color': 'black',
                        'circle-stroke-width':3,
                           },
                           'source-layer': 'Total_grocery_stores-6tzhl7'
                       });
                       const popup = new mapboxgl.Popup({
                        closeButton : false,
                        closeOnClick: false
                    });
    map.on('mouseover', 'grocery-stores', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            const coordinates = e.features[0].geometry.coordinates.slice();
            const properties = e.features[0].properties;
            const name = properties['Entity Name'];
            const city = properties['City'];
            const county = properties['County'];
            const address = properties['Street Address'];
            const state = properties['State'];
            const dba_name = properties['DBA Name'];
            const establishment_type = properties['Establishment Type'];
            const operation_type = properties['Operation Type'];
            const sq_ft = properties['Square Footage'];
            const zip = properties['Zip Code'];
            const license_number = properties['License Number'];
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            const html = "<b><u>Name:</b></u> " + name + '<br>' +
                        "<b><u>City:</b></u> " + city + '<br>' +
                        "<b><u>County:</b></u> " + county + '<br>' +
                        "<b><u>Address:</b></u> " + address + '<br>' +
                        "<b><u>State:</b></u> " + state + '<br>' +
                        "<b><u>DBA Name:</b></u> " + dba_name + '<br>' +
                        "<b><u>Establishment Type:</b></u> " + establishment_type + '<br>' +
                        "<b><u>Operation Type:</b></u> " + operation_type + '<br>' +
                        "<b><u>Square feet:</b></u> " + sq_ft + '<br>' +
                        "<b><u>Zipcode:</b></u> " + zip + '<br>' +
                        "<b><u>License Number:</b></u> " + license_number + '<br>'
            popup.setLngLat(coordinates).setHTML(html).addTo(map);
        })
             map.on('mouseleave', 'grocery-stores', () => {
                 map.getCanvas().style.cursor = '';
                 popup.remove();
             });
                   }
                   else {
                       const visibility = map.getLayoutProperty('grocery-stores', 'visibility');
                        if(visibility === "none")
                        {
                            map.setLayoutProperty('grocery-stores', 'visibility', 'visible');
                        }
                        else
                        {
                            map.setLayoutProperty('grocery-stores', 'visibility', 'none');
                        }
                   }
                 }
               function showmarker2() {
                   if (typeof map.getSource('farmers-markets') === 'undefined') {
                       map.addSource('farmers-markets', {
                            type: 'vector',
                            url: 'mapbox://arielb1.af9vybob'
                        });
                        map.addLayer({
                            'id': 'farmers-markets',
                            'type': 'circle',
                            'source': 'farmers-markets',
                            'layout': {
                                'visibility': 'visible'
                            },
                            'paint': {
                                'circle-radius': 4,
                                'circle-color': 'rgba(0,128,0,1)',
                                'circle-stroke-color': 'black',
                        'circle-stroke-width':3,
                            },
                            'source-layer': 'DOHMH_Farmers_Markets-ccwyus'
                        });
                        let popup = new mapboxgl.Popup({
                            closeButton: false,
                            closeOnClick: false
                        });

                        map.on('mouseenter', 'farmers-markets', (e) => {
                            map.getCanvas().style.cursor = 'pointer';
                            const coordinates = e.features[0].geometry.coordinates.slice();
                            let properties = e.features[0].properties;
                            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                            }
                            properties = JSON.stringify(properties).replaceAll('\"', '').replaceAll(',', '<br>').replaceAll('{', '').replaceAll('}', '').replaceAll();
                            console.log(properties);
                            popup.setLngLat(coordinates).setHTML(properties).addTo(map);
                        });
                        map.on('mouseleave', 'farmers-markets', (e) => {
                            map.getCanvas().style.cursor = '';
                            popup.remove();
                        });
                   }
                   else
                   {
                       const visibility = map.getLayoutProperty('farmers-markets', 'visibility');
                        if(visibility === "none")
                        {
                            map.setLayoutProperty('farmers-markets', 'visibility', 'visible');
                        }
                        else
                        {
                            map.setLayoutProperty('farmers-markets', 'visibility', 'none');
                        }
                   }
               }
               function showmarker3() {
                       if (typeof map.getSource('fire-houses') === 'undefined') {
                           map.addSource('fire-houses', {
                           type: 'vector',
                           url: 'mapbox://arielb1.388xpmrj'
                       });
                           map.addLayer({
                           'id': 'fire-houses',
                           'type': 'circle',
                           'source': 'fire-houses',
                           'layout': {
                               'visibility': 'visible'
                           },
                           'paint': {
                               'circle-radius': 4,
                               'circle-color': 'rgba(255,0,0,1)',
                               'circle-stroke-color': 'black',
                        'circle-stroke-width':3
                           },
                           'source-layer': 'FDNY_Firehouse_Listing-4hvksv'
                       });
                       let popup = new mapboxgl.Popup({
                            closeButton: false,
                            closeOnClick: false
                        });
                           map.on('mouseenter', 'fire-houses', (e) => {
                                map.getCanvas().style.cursor = 'pointer';
                                const coordinates = e.features[0].geometry.coordinates.slice();
                                let properties = e.features[0].properties;
                                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                                }
                                properties = JSON.stringify(properties).replaceAll('\"', '').replaceAll(',', '<br>').replaceAll('{', '').replaceAll('}', '');
                                popup.setLngLat(coordinates).setHTML(properties).addTo(map);
                            });
                           map.on('mouseleave', 'fire-houses', (e) => {
                                map.getCanvas().style.cursor = '';
                                popup.remove();
                            });
                       }
                       else
                       {
                           const visibility = map.getLayoutProperty('fire-houses', 'visibility');
                            if(visibility === "none")
                            {
                                map.setLayoutProperty('fire-houses', 'visibility', 'visible');
                            }
                            else
                            {
                                map.setLayoutProperty('fire-houses', 'visibility', 'none');
                            }
                       }
               }


              function showmarker4(){
                   if(typeof map.getSource('super-markets') === 'undefined')
                   {
                       map.addSource('super-markets', {
                            type: 'vector',
                            url: 'mapbox://arielb1.dftl2j6f'
                        });
                       map.addLayer({
                        'id': 'super-markets',
                        'type': 'circle',
                        'source': 'super-markets',
                        'layout': {
                            'visibility': 'visible'
                        },
                        'paint': {
                            'circle-radius': 4,
                            'circle-color': 'rgba(255,0,255,1)',
                            'circle-stroke-color': 'black',
                        'circle-stroke-width':3,

                        },
                        'source-layer': 'Supermarkets-52ltms'
                    });
                                              let popup = new mapboxgl.Popup({
                            closeButton: false,
                            closeOnClick: false
                        });
                           map.on('mouseenter', 'super-markets', (e) => {
                                map.getCanvas().style.cursor = 'pointer';
                                const coordinates = e.features[0].geometry.coordinates.slice();
                                let properties = e.features[0].properties;
                                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                                }
                                properties = JSON.stringify(properties).replaceAll('\"', '').replaceAll(',', '<br>').replaceAll('{', '').replaceAll('}', '');
                                popup.setLngLat(coordinates).setHTML(properties).addTo(map);
                            });
                           map.on('mouseleave', 'super-markets', (e) => {
                                map.getCanvas().style.cursor = '';
                                popup.remove();
                            });
                   }
                   else
                   {
                       const visibility = map.getLayoutProperty('super-markets', 'visibility');
                        if(visibility === "none")
                        {
                            map.setLayoutProperty('super-markets', 'visibility', 'visible');
                        }
                        else
                        {
                            map.setLayoutProperty('super-markets', 'visibility', 'none');
                        }
                   }
               }
               function showmarker5(){
                   if(typeof map.getSource('super-centers') === 'undefined')
                   {
                       map.addSource('super-centers', {
                            type: 'vector',
                            url: 'mapbox://arielb1.bx5tiqmq'
                        });
                       map.addLayer({
                        'id': 'super-centers',
                        'type': 'circle',
                        'source': 'super-centers',
                        'layout': {
                            'visibility': 'visible'
                        },
                        
                        'paint': {
                            'circle-radius': 4,
                            'circle-color': 'rgba(220,88,42,1)',
                            'circle-stroke-color': 'black',
                        'circle-stroke-width':3,

                        },
                        'source-layer': 'Supercenters-49gbzn'
                    });
                                                                     let popup = new mapboxgl.Popup({
                            closeButton: false,
                            closeOnClick: false
                        });
                           map.on('mouseenter', 'super-centers', (e) => {
                                map.getCanvas().style.cursor = 'pointer';
                                const coordinates = e.features[0].geometry.coordinates.slice();
                                let properties = e.features[0].properties;
                                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                                }
                                properties = JSON.stringify(properties).replaceAll('\"', '').replaceAll(',', '<br>').replaceAll('{', '').replaceAll('}', '');
                                popup.setLngLat(coordinates).setHTML(properties).addTo(map);
                            });
                           map.on('mouseleave', 'super-centers', (e) => {
                                map.getCanvas().style.cursor = '';
                                popup.remove();
                            });
                   }
                   else
                   {
                       const visibility = map.getLayoutProperty('super-centers', 'visibility');
                        if(visibility === "none")
                        {
                            map.setLayoutProperty('super-centers', 'visibility', 'visible');
                        }
                        else
                        {
                            map.setLayoutProperty('super-centers', 'visibility', 'none');
                        }
                   }
               }

         function showdirections(){
             let possible_layers = ['fire-houses', 'grocery-stores', 'super-centers', 'farmers-markets'];
          if(!directionsshowing){
              let existing_layers = []
              for (layer of possible_layers)
              {
                  if(typeof map.getLayer(layer) !== 'undefined' && map.getLayoutProperty(layer, 'visibility') === 'visible')
                  {
                      existing_layers.push(layer);
                  }
              }
              let points = map.queryRenderedFeatures(
                 {
                     layers: existing_layers
                 }
             );
              directionsshowing = true;
            let radius = parseFloat(document.getElementById('radius-input').value);
            let circle_buffer = turf.buffer(user_location, radius, {units: 'miles'});
            var points_in_circle = points.filter(function (marker) {
                return turf.booleanPointInPolygon(marker, circle_buffer);
            });
            if(points_in_circle.length > 0)
            {
            let closest_marker = turf.nearestPoint(user_location, turf.featureCollection(points));
              if(user_location != null && closest_marker != null)
              {
                  map.addControl(directions, "top-left");
                  directions.setOrigin(user_location.geometry.coordinates);
                  directions.setDestination(closest_marker.geometry.coordinates);
              }
            }
          }
          else
          {
              directionsshowing = false;
              map.setZoom(11);
              if(map.hasControl(directions))
              {
                  map.removeControl(directions);
              }
              console.log("There are no establishments in this radius")
          }
        }






        
    </script>





<script>



map.on('load', () => {
// Add a geojson point source.
// Heatmap layers also work with a vector tile source.
map.addSource('grocery-stores', {
'type': 'vector',
'url': 'mapbox://arielb1.38i7mvbz'
});
 
map.addLayer(
{
'id': 'grocery-stores-heat',
'type': 'heatmap',
'source': 'grocery-stores',
'source-layer': 'Total_grocery_stores-6tzhl7',
'maxzoom': 9,
'paint': {
// Increase the heatmap weight based on frequency and property magnitude
'heatmap-weight': [
'interpolate',
['linear'],
['get', 'mag'],
0,
0,
6,
1
],
// Increase the heatmap color weight weight by zoom level
// heatmap-intensity is a multiplier on top of heatmap-weight
'heatmap-intensity': [
'interpolate',
['linear'],
['zoom'],
0,
1,
9,
3
],
// Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
// Begin color ramp at 0-stop with a 0-transparancy color
// to create a blur-like effect.
'heatmap-color': [
'interpolate',
['linear'],
['heatmap-density'],
0,
'rgba(33,102,172,0)',
0.2,
'rgb(103,169,207)',
0.4,
'rgb(209,229,240)',
0.6,
'rgb(253,219,199)',
0.8,
'rgb(239,138,98)',
1,
'rgb(178,24,43)'
],
// Adjust the heatmap radius by zoom level
'heatmap-radius': [
'interpolate',
['linear'],
['zoom'],
0,
2,
1,
29
],
// Transition from heatmap to circle layer by zoom level
'heatmap-opacity': [
'interpolate',
['linear'],
['zoom'],
7,
1,
9,
0
]
}
},
// 'waterway-label'
);
 
map.addLayer(
{
'id': 'grocery-stores-point',
'type': 'circle',
'source': 'grocery-stores',
'source-layer': 'Total_grocery_stores-6tzhl7',
'minzoom': 7,
'paint': {
// Size circle radius by earthquake magnitude and zoom level
'circle-radius': [
'interpolate',
['linear'],
['zoom'],
7,
['interpolate', ['linear'], ['get', 'mag'], 1, 1, 6, 4],
16,
['interpolate', ['linear'], ['get', 'mag'], 1, 5, 6, 50]
],
// Color circle by earthquake magnitude
'circle-color': [
'interpolate',
['linear'],
['get', 'mag'],
1,
'rgba(33,102,172,0)',
2,
'rgb(103,169,207)',
3,
'rgb(209,229,240)',
4,
'rgb(253,219,199)',
5,
'rgb(239,138,98)',
6,
'rgb(178,24,43)'
],
'circle-stroke-color': 'white',
'circle-stroke-width': 1,
// Transition from heatmap to circle layer by zoom level
'circle-opacity': [
'interpolate',
['linear'],
['zoom'],
7,
0,
8,
1
]
}
 },
// 'waterway-label'
);
});
</script>
  </body>
</html>
